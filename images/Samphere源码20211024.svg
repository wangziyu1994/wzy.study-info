<svg id="SvgjsSvg1006" width="2135.875" height="1947.537504196167" xmlns="http://www.w3.org/2000/svg" version="1.1" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns:svgjs="http://svgjs.com/svgjs"><defs id="SvgjsDefs1007"><marker id="SvgjsMarker1046" markerWidth="30" markerHeight="26" refX="18" refY="13" viewBox="0 0 30 26" orient="auto" markerUnits="userSpaceOnUse" stroke-dasharray="0,0"><path id="SvgjsPath1047" d="M0,0 L30,13 L0,26 L0,0" fill="#64b5f6" stroke="#64b5f6" stroke-width="1"></path></marker><marker id="SvgjsMarker1140" markerWidth="30" markerHeight="26" refX="18" refY="13" viewBox="0 0 30 26" orient="auto" markerUnits="userSpaceOnUse" stroke-dasharray="0,0"><path id="SvgjsPath1141" d="M0,0 L30,13 L0,26 L0,0" fill="#f57f17" stroke="#f57f17" stroke-width="1"></path></marker><marker id="SvgjsMarker1144" markerWidth="30" markerHeight="26" refX="18" refY="13" viewBox="0 0 30 26" orient="auto" markerUnits="userSpaceOnUse" stroke-dasharray="0,0"><path id="SvgjsPath1145" d="M0,0 L30,13 L0,26 L0,0" fill="#64b5f6" stroke="#64b5f6" stroke-width="1"></path></marker><marker id="SvgjsMarker1184" markerWidth="14" markerHeight="10" refX="10" refY="5" viewBox="0 0 14 10" orient="auto" markerUnits="userSpaceOnUse" stroke-dasharray="0,0"><path id="SvgjsPath1185" d="M0,0 L14,5 L0,10 L0,0" fill="#323232" stroke="#323232" stroke-width="1"></path></marker><marker id="SvgjsMarker1222" markerWidth="14" markerHeight="10" refX="10" refY="5" viewBox="0 0 14 10" orient="auto" markerUnits="userSpaceOnUse" stroke-dasharray="0,0"><path id="SvgjsPath1223" d="M0,0 L14,5 L0,10 L0,0" fill="#323232" stroke="#323232" stroke-width="1"></path></marker><marker id="SvgjsMarker1280" markerWidth="30" markerHeight="26" refX="18" refY="13" viewBox="0 0 30 26" orient="auto" markerUnits="userSpaceOnUse" stroke-dasharray="0,0"><path id="SvgjsPath1281" d="M0,0 L30,13 L0,26 L0,0" fill="#f57f17" stroke="#f57f17" stroke-width="1"></path></marker><marker id="SvgjsMarker1284" markerWidth="30" markerHeight="26" refX="18" refY="13" viewBox="0 0 30 26" orient="auto" markerUnits="userSpaceOnUse" stroke-dasharray="0,0"><path id="SvgjsPath1285" d="M0,0 L30,13 L0,26 L0,0" fill="#64b5f6" stroke="#64b5f6" stroke-width="1"></path></marker><marker id="SvgjsMarker1296" markerWidth="14" markerHeight="10" refX="10" refY="5" viewBox="0 0 14 10" orient="auto" markerUnits="userSpaceOnUse" stroke-dasharray="0,0"><path id="SvgjsPath1297" d="M0,0 L14,5 L0,10 L0,0" fill="#323232" stroke="#323232" stroke-width="1"></path></marker><marker id="SvgjsMarker1304" markerWidth="20" markerHeight="16" refX="13" refY="8" viewBox="0 0 20 16" orient="auto" markerUnits="userSpaceOnUse" stroke-dasharray="0,0"><path id="SvgjsPath1305" d="M0,0 L20,8 L0,16 L0,0" fill="#323232" stroke="#323232" stroke-width="1"></path></marker></defs><g id="SvgjsG1008" transform="translate(37.008336385091184,102.52499198913574)"><path id="SvgjsPath1009" d="M 0 0L 820.4666735331217 0L 820.4666735331217 1542.6000366210938L 0 1542.6000366210938Z" stroke="rgba(50,50,50,1)" stroke-width="2" fill-opacity="1" fill="#ffffff"></path><g id="SvgjsG1010"><text id="SvgjsText1011" font-family="微软雅黑" text-anchor="middle" font-size="20px" width="801px" fill="#323232" font-weight="400" align="top" lineHeight="125%" anchor="middle" family="微软雅黑" size="20px" weight="400" font-style="" opacity="1" y="-2.5" transform="rotate(0)"><tspan id="SvgjsTspan1012" dy="25" x="410.5"><tspan id="SvgjsTspan1013" style="text-decoration:;">Samaphore</tspan></tspan></text></g></g><g id="SvgjsG1014" transform="translate(909.8750152587891,107.5250072479248)"><path id="SvgjsPath1015" d="M 0 0L 1200.6000061035156 0L 1200.6000061035156 1815.6000671386719L 0 1815.6000671386719Z" stroke="rgba(50,50,50,1)" stroke-width="2" fill-opacity="1" fill="#ffffff"></path><g id="SvgjsG1016"><text id="SvgjsText1017" font-family="微软雅黑" text-anchor="middle" font-size="20px" width="1181px" fill="#323232" font-weight="400" align="top" lineHeight="125%" anchor="middle" family="微软雅黑" size="20px" weight="400" font-style="" opacity="1" y="-2.5" transform="rotate(0)"><tspan id="SvgjsTspan1018" dy="25" x="600.5"><tspan id="SvgjsTspan1019" style="text-decoration:;">AbstractSynchronizedQueue</tspan></tspan></text></g></g><g id="SvgjsG1020" transform="translate(45.008336385091184,150.12499809265137)"><path id="SvgjsPath1021" d="M 0 0L 605.4000034332275 0L 605.4000034332275 468.4000015258789L 0 468.4000015258789Z" stroke="rgba(50,50,50,1)" stroke-width="2" fill-opacity="1" fill="#ffffff"></path><g id="SvgjsG1022"><text id="SvgjsText1023" font-family="微软雅黑" text-anchor="middle" font-size="20px" width="586px" fill="#323232" font-weight="400" align="top" lineHeight="125%" anchor="middle" family="微软雅黑" size="20px" weight="400" font-style="" opacity="1" y="-2.5" transform="rotate(0)"><tspan id="SvgjsTspan1024" dy="25" x="303"><tspan id="SvgjsTspan1025" style="text-decoration:;">NonfairSync</tspan></tspan></text></g></g><g id="SvgjsG1026" transform="translate(41.008336385091184,774.9916661580404)"><path id="SvgjsPath1027" d="M 0 0L 360.06667582194007 0L 360.06667582194007 219.5333334604899L 0 219.5333334604899Z" stroke="rgba(50,50,50,1)" stroke-width="2" fill-opacity="1" fill="#ffffff"></path><g id="SvgjsG1028"><text id="SvgjsText1029" font-family="微软雅黑" text-anchor="middle" font-size="20px" width="341px" fill="#323232" font-weight="400" align="top" lineHeight="125%" anchor="middle" family="微软雅黑" size="20px" weight="400" font-style="" opacity="1" y="-2.5" transform="rotate(0)"><tspan id="SvgjsTspan1030" dy="25" x="180.5"><tspan id="SvgjsTspan1031" style="text-decoration:;">fairSync</tspan></tspan></text></g></g><g id="SvgjsG1032" transform="translate(41.008336385091184,251.99166806538904)"><path id="SvgjsPath1033" d="M 0 0L 278.0666681925454 0L 278.0666681925454 25.533331553141267L 0 25.533331553141267Z" stroke="rgba(50,50,50,1)" stroke-width="2" fill-opacity="1" fill="#ffffff"></path><g id="SvgjsG1034"><text id="SvgjsText1035" font-family="微软雅黑" text-anchor="middle" font-size="15px" width="259px" fill="#323232" font-weight="400" align="top" lineHeight="125%" anchor="middle" family="微软雅黑" size="15px" weight="400" font-style="" opacity="1" y="-1.875" transform="rotate(0)"><tspan id="SvgjsTspan1036" dy="18" x="139.5"><tspan id="SvgjsTspan1037" style="text-decoration:;">acquireSharedInterruptibly</tspan></tspan></text></g></g><g id="SvgjsG1038" transform="translate(972.9083097775779,213.991668065389)"><path id="SvgjsPath1039" d="M 0 0L 541.9667359987893 0L 541.9667359987893 932.1333452860514L 0 932.1333452860514Z" stroke="rgba(50,50,50,1)" stroke-width="2" fill-opacity="1" fill="#ffffff"></path><g id="SvgjsG1040"><text id="SvgjsText1041" font-family="微软雅黑" text-anchor="middle" font-size="15px" width="522px" fill="#323232" font-weight="400" align="top" lineHeight="125%" anchor="middle" family="微软雅黑" size="15px" weight="400" font-style="" opacity="1" y="-1.875" transform="rotate(0)"><tspan id="SvgjsTspan1042" dy="18" x="271"><tspan id="SvgjsTspan1043" style="text-decoration:;">acquireSharedInterruptibly</tspan></tspan></text></g></g><g id="SvgjsG1044"><path id="SvgjsPath1045" d="M320.0750045776366 264.75833384195965L349.0750045776366 264.75833384195965L349.0750045776366 181.65833473205566L1243.8916777769728 181.65833473205566L1243.8916777769728 199.991668065389" stroke="#64b5f6" stroke-width="10" fill="none" marker-end="url(#SvgjsMarker1046)"></path></g><g id="SvgjsG1048" transform="translate(1130.491665283839,289.5249996185303)"><path id="SvgjsPath1049" d="M 0 0L 228.26667277018214 0L 228.26667277018214 30.533331553141267L 0 30.533331553141267Z" stroke="rgba(50,50,50,1)" stroke-width="2" fill-opacity="1" fill="#ffffff"></path><g id="SvgjsG1050"><text id="SvgjsText1051" font-family="微软雅黑" text-anchor="middle" font-size="15px" width="209px" fill="#323232" font-weight="400" align="top" lineHeight="125%" anchor="middle" family="微软雅黑" size="15px" weight="400" font-style="" opacity="1" y="-1.875" transform="rotate(0)"><tspan id="SvgjsTspan1052" dy="18" x="114.5"><tspan id="SvgjsTspan1053" style="text-decoration:;">tryAcquireShared(arg)</tspan></tspan></text></g></g><g id="SvgjsG1054" transform="translate(49.008336385091184,374.99166806538904)"><path id="SvgjsPath1055" d="M 0 0L 278.0666681925455 0L 278.0666681925455 167.53333155314127L 0 167.53333155314127Z" stroke="rgba(50,50,50,1)" stroke-width="2" fill-opacity="1" fill="#ffffff"></path><g id="SvgjsG1056"><text id="SvgjsText1057" font-family="微软雅黑" text-anchor="middle" font-size="15px" width="259px" fill="#323232" font-weight="400" align="top" lineHeight="125%" anchor="middle" family="微软雅黑" size="15px" weight="400" font-style="" opacity="1" y="-1.875" transform="rotate(0)"><tspan id="SvgjsTspan1058" dy="18" x="139.5"><tspan id="SvgjsTspan1059" style="text-decoration:;">tryAcquireShared(arg)</tspan></tspan></text></g></g><g id="SvgjsG1060" transform="translate(55.008336385091184,411.99166806538904)"><path id="SvgjsPath1061" d="M 0 0L 257.46666971842444 0L 257.46666971842444 22.133330027262332L 0 22.133330027262332Z" stroke="rgba(50,50,50,1)" stroke-width="2" fill-opacity="1" fill="#ffffff"></path><g id="SvgjsG1062"><text id="SvgjsText1063" font-family="微软雅黑" text-anchor="middle" font-size="15px" width="238px" fill="#323232" font-weight="400" align="top" lineHeight="125%" anchor="middle" family="微软雅黑" size="15px" weight="400" font-style="" opacity="1" y="-1.875" transform="rotate(0)"><tspan id="SvgjsTspan1064" dy="18" x="129"><tspan id="SvgjsTspan1065" style="text-decoration:;">(hasQueuedPredecessors()</tspan></tspan></text></g></g><g id="SvgjsG1066" transform="translate(1617.2749671936035,213.991668065389)"><path id="SvgjsPath1067" d="M 0 0L 355.39998626708984 0L 355.39998626708984 548.200008392334L 0 548.200008392334Z" stroke="rgba(50,50,50,1)" stroke-width="2" fill-opacity="1" fill="#ffffff"></path><g id="SvgjsG1068"><text id="SvgjsText1069" font-family="微软雅黑" text-anchor="middle" font-size="12px" width="336px" fill="#323232" font-weight="700" align="top" lineHeight="125%" anchor="middle" family="微软雅黑" size="12px" weight="700" font-style="" opacity="1" y="-1.5" transform="rotate(0)"><tspan id="SvgjsTspan1070" dy="15" x="178"><tspan id="SvgjsTspan1071" style="text-decoration:;">hasQueuedPredecessors()</tspan></tspan><tspan id="SvgjsTspan1072" dy="15" x="178"><tspan id="SvgjsTspan1073" style="text-decoration:;"> 1.h==t </tspan></tspan><tspan id="SvgjsTspan1074" dy="15" x="178"><tspan id="SvgjsTspan1075" style="text-decoration:;"> </tspan></tspan><tspan id="SvgjsTspan1076" dy="15" x="178"><tspan id="SvgjsTspan1077" style="text-decoration:;">1. 队列没有初始化----------------》没有竞争条件，直接尝试</tspan></tspan><tspan id="SvgjsTspan1078" dy="15" x="178"><tspan id="SvgjsTspan1079" style="text-decoration:;">获得锁，不用考虑入队问题，获取锁失败，再考虑入队获得锁</tspan></tspan><tspan id="SvgjsTspan1080" dy="15" x="178"><tspan id="SvgjsTspan1081" style="text-decoration:;"> </tspan></tspan><tspan id="SvgjsTspan1082" dy="15" x="178"><tspan id="SvgjsTspan1083" style="text-decoration:;">2.  队列只有一个节点，头尾节点相同</tspan></tspan><tspan id="SvgjsTspan1084" dy="15" x="178"><tspan id="SvgjsTspan1085" style="text-decoration:;"> </tspan></tspan><tspan id="SvgjsTspan1086" dy="15" x="178"><tspan id="SvgjsTspan1087" style="text-decoration:;"> 2.1 队列刚刚被初始化，head=tail时此时队列只有一个初始化</tspan></tspan><tspan id="SvgjsTspan1088" dy="15" x="178"><tspan id="SvgjsTspan1089" style="text-decoration:;">的空节点。此时若正好有线程进入，那么也可以直接获得锁。</tspan></tspan><tspan id="SvgjsTspan1090" dy="15" x="178"><tspan id="SvgjsTspan1091" style="text-decoration:;"> </tspan></tspan><tspan id="SvgjsTspan1092" dy="15" x="178"><tspan id="SvgjsTspan1093" style="text-decoration:;"> </tspan></tspan><tspan id="SvgjsTspan1094" dy="15" x="178"><tspan id="SvgjsTspan1095" style="text-decoration:;"> </tspan></tspan><tspan id="SvgjsTspan1096" dy="15" x="178"><tspan id="SvgjsTspan1097" style="text-decoration:;"> 2.h!=t </tspan></tspan><tspan id="SvgjsTspan1098" dy="15" x="178"><tspan id="SvgjsTspan1099" style="text-decoration:;"> </tspan></tspan><tspan id="SvgjsTspan1100" dy="15" x="178"><tspan id="SvgjsTspan1101" style="text-decoration:;">​    1.head.next=null</tspan></tspan><tspan id="SvgjsTspan1102" dy="15" x="178"><tspan id="SvgjsTspan1103" style="text-decoration:;"> </tspan></tspan><tspan id="SvgjsTspan1104" dy="15" x="178"><tspan id="SvgjsTspan1105" style="text-decoration:;">   队列中只有两个节点。-----------》队列中有且只有一个线程</tspan></tspan><tspan id="SvgjsTspan1106" dy="15" x="178"><tspan id="SvgjsTspan1107" style="text-decoration:;">节点正在排队，那么此线程节点完全有资格尝试获得锁。</tspan></tspan><tspan id="SvgjsTspan1108" dy="15" x="178"><tspan id="SvgjsTspan1109" style="text-decoration:;"> </tspan></tspan><tspan id="SvgjsTspan1110" dy="15" x="178"><tspan id="SvgjsTspan1111" style="text-decoration:;">​</tspan></tspan><tspan id="SvgjsTspan1112" dy="15" x="178"><tspan id="SvgjsTspan1113" style="text-decoration:;">    2.head.next!=null,head.next.thread=Thread.currentT</tspan></tspan><tspan id="SvgjsTspan1114" dy="15" x="178"><tspan id="SvgjsTspan1115" style="text-decoration:;">hread</tspan></tspan><tspan id="SvgjsTspan1116" dy="15" x="178"><tspan id="SvgjsTspan1117" style="text-decoration:;"> </tspan></tspan><tspan id="SvgjsTspan1118" dy="15" x="178"><tspan id="SvgjsTspan1119" style="text-decoration:;"> 队列中有两个以上节点,并且此时队列排队节点的首位节点就是</tspan></tspan><tspan id="SvgjsTspan1120" dy="15" x="178"><tspan id="SvgjsTspan1121" style="text-decoration:;">当前线程节点，那么此线程节点完全由资格资格获得锁.</tspan></tspan><tspan id="SvgjsTspan1122" dy="15" x="178"><tspan id="SvgjsTspan1123" style="text-decoration:;"> </tspan></tspan><tspan id="SvgjsTspan1124" dy="15" x="178"><tspan id="SvgjsTspan1125" style="text-decoration:;">   </tspan></tspan><tspan id="SvgjsTspan1126" dy="15" x="178"><tspan id="SvgjsTspan1127" style="text-decoration:;">3.head.next!=null,head.next.thread!=Thread.currentTh</tspan></tspan><tspan id="SvgjsTspan1128" dy="15" x="178"><tspan id="SvgjsTspan1129" style="text-decoration:;">read</tspan></tspan><tspan id="SvgjsTspan1130" dy="15" x="178"><tspan id="SvgjsTspan1131" style="text-decoration:;"> </tspan></tspan><tspan id="SvgjsTspan1132" dy="15" x="178"><tspan id="SvgjsTspan1133" style="text-decoration:;"> 队列中有两个以上节点,并且此时队列排队节点的首位节点不是</tspan></tspan><tspan id="SvgjsTspan1134" dy="15" x="178"><tspan id="SvgjsTspan1135" style="text-decoration:;">当前线程节点，那么当前线程节点只能去乖乖排队等待获取锁的</tspan></tspan><tspan id="SvgjsTspan1136" dy="15" x="178"><tspan id="SvgjsTspan1137" style="text-decoration:;">资格</tspan></tspan></text></g></g><g id="SvgjsG1138"><path id="SvgjsPath1139" d="M1129.491665283839 304.79166539510095L25.008336385091184 304.79166539510095L25.008336385091184 423.0583330790202L41.008336385091184 423.0583330790202" stroke="#f57f17" stroke-width="10" fill="none" marker-end="url(#SvgjsMarker1140)"></path></g><g id="SvgjsG1142"><path id="SvgjsPath1143" d="M313.4750061035156 423.0583330790202L494.4750061035156 423.0583330790202L494.4750061035156 24.991668065389007L1794.9749603271484 24.991668065389007L1794.9749603271484 199.991668065389" stroke="#64b5f6" stroke-width="10" fill="none" marker-end="url(#SvgjsMarker1144)"></path></g><g id="SvgjsG1146" transform="translate(1047.491665283839,389.12499809265137)"><path id="SvgjsPath1147" d="M 0 0L 394.26667277018214 0L 394.26667277018214 256.00000381469727L 0 256.00000381469727Z" stroke="rgba(50,50,50,1)" stroke-width="2" fill-opacity="1" fill="#ffffff"></path><g id="SvgjsG1148"><text id="SvgjsText1149" font-family="微软雅黑" text-anchor="middle" font-size="15px" width="375px" fill="#323232" font-weight="400" align="top" lineHeight="125%" anchor="middle" family="微软雅黑" size="15px" weight="400" font-style="" opacity="1" y="-1.875" transform="rotate(0)"><tspan id="SvgjsTspan1150" dy="18" x="197.5"><tspan id="SvgjsTspan1151" style="text-decoration:;">doAcquireSharedInterruptibly(arg)</tspan></tspan><tspan id="SvgjsTspan1152" dy="18" x="197.5"><tspan id="SvgjsTspan1153" style="text-decoration:;"> </tspan></tspan><tspan id="SvgjsTspan1154" dy="18" x="197.5"><tspan id="SvgjsTspan1155" style="text-decoration:;">首先放入队列，并且入队节点是Node.SHARED模式，循</tspan></tspan><tspan id="SvgjsTspan1156" dy="18" x="197.5"><tspan id="SvgjsTspan1157" style="text-decoration:;">环，每次获取构建节点的前置节点。判断是否是队列的</tspan></tspan><tspan id="SvgjsTspan1158" dy="18" x="197.5"><tspan id="SvgjsTspan1159" style="text-decoration:;">head节点。如果不是的话，进入AQS的</tspan></tspan><tspan id="SvgjsTspan1160" dy="18" x="197.5"><tspan id="SvgjsTspan1161" style="text-decoration:;">shouldParkAfterFaILedAcquire方法，此方法和</tspan></tspan><tspan id="SvgjsTspan1162" dy="18" x="197.5"><tspan id="SvgjsTspan1163" style="text-decoration:;">ReenTrantLock的方法一样。就是判断前置节点的状态是</tspan></tspan><tspan id="SvgjsTspan1164" dy="18" x="197.5"><tspan id="SvgjsTspan1165" style="text-decoration:;">否为-1，如果不为-1的话设置为-1 返回false进行下一次</tspan></tspan><tspan id="SvgjsTspan1166" dy="18" x="197.5"><tspan id="SvgjsTspan1167" style="text-decoration:;">循环。下一次循环如果还是不是head并且获取共享资源</tspan></tspan><tspan id="SvgjsTspan1168" dy="18" x="197.5"><tspan id="SvgjsTspan1169" style="text-decoration:;">失败的话，那么再次进入</tspan></tspan><tspan id="SvgjsTspan1170" dy="18" x="197.5"><tspan id="SvgjsTspan1171" style="text-decoration:;">shouldParkAfterFaILedAcquire方法。因为前置节点已</tspan></tspan><tspan id="SvgjsTspan1172" dy="18" x="197.5"><tspan id="SvgjsTspan1173" style="text-decoration:;">被设置为-1，代表前置节点的next节点需要被阻塞的状</tspan></tspan><tspan id="SvgjsTspan1174" dy="18" x="197.5"><tspan id="SvgjsTspan1175" style="text-decoration:;">态。那么接下来进入parkAndCheckInterrupt方法。</tspan></tspan><tspan id="SvgjsTspan1176" dy="18" x="197.5"><tspan id="SvgjsTspan1177" style="text-decoration:;">LockSupport.park()方法阻塞此线程。 </tspan></tspan><tspan id="SvgjsTspan1178" dy="18" x="197.5"><tspan id="SvgjsTspan1179" style="text-decoration:;"> </tspan></tspan><tspan id="SvgjsTspan1180" dy="18" x="197.5"><tspan id="SvgjsTspan1181" style="text-decoration:;"> </tspan></tspan></text></g></g><g id="SvgjsG1182"><path id="SvgjsPath1183" d="M1244.62500166893 321.0583311716715L1244.62500166893 380.8583304087321" stroke="#323232" stroke-width="2" fill="none" marker-end="url(#SvgjsMarker1184)"></path><rect id="SvgjsRect1186" width="25" height="22" x="1232.12500166893" y="339.9583307902018" fill="#ffffff"></rect><text id="SvgjsText1187" font-family="微软雅黑" text-anchor="middle" font-size="18px" width="25px" fill="#323232" font-weight="700" align="top" lineHeight="23px" anchor="middle" family="微软雅黑" size="18px" weight="700" font-style="" opacity="1" y="337.7083307902018" transform="rotate(0)"><tspan id="SvgjsTspan1188" dy="22" x="1244.62500166893"><tspan id="SvgjsTspan1189" style="text-decoration:;">&lt;0</tspan></tspan></text></g><g id="SvgjsG1190" transform="translate(989.6916469732921,748.524995803833)"><path id="SvgjsPath1191" d="M 0 0L 509.8667093912759 0L 509.8667093912759 272.4666741689048L 0 272.4666741689048Z" stroke="rgba(50,50,50,1)" stroke-width="2" fill-opacity="1" fill="#ffffff"></path><g id="SvgjsG1192"><text id="SvgjsText1193" font-family="微软雅黑" text-anchor="middle" font-size="15px" width="490px" fill="#323232" font-weight="400" align="top" lineHeight="125%" anchor="middle" family="微软雅黑" size="15px" weight="400" font-style="" opacity="1" y="-1.875" transform="rotate(0)"><tspan id="SvgjsTspan1194" dy="18" x="255"><tspan id="SvgjsTspan1195" style="text-decoration:;">setHeadAndPropagate(Node node, int propagate)</tspan></tspan><tspan id="SvgjsTspan1196" dy="18" x="255"><tspan id="SvgjsTspan1197" style="text-decoration:;"> </tspan></tspan><tspan id="SvgjsTspan1198" dy="18" x="255"><tspan id="SvgjsTspan1199" style="text-decoration:;">1. **如果在当前线程消耗共享资源之后，仍然有可用的共享资源，那么当</tspan></tspan><tspan id="SvgjsTspan1200" dy="18" x="255"><tspan id="SvgjsTspan1201" style="text-decoration:;">前线程不仅要自己占用锁，还要唤醒队列中其他可以占用锁资源的线程。</tspan></tspan><tspan id="SvgjsTspan1202" dy="18" x="255"><tspan id="SvgjsTspan1203" style="text-decoration:;">**</tspan></tspan><tspan id="SvgjsTspan1204" dy="18" x="255"><tspan id="SvgjsTspan1205" style="text-decoration:;">2. **还有一个重要作用是配合tryReleased的方法解决一个BUG：当一个</tspan></tspan><tspan id="SvgjsTspan1206" dy="18" x="255"><tspan id="SvgjsTspan1207" style="text-decoration:;">线程刚执行完compareAndSetWaitStatus(h, Node.SIGNAL, 0)方法，另</tspan></tspan><tspan id="SvgjsTspan1208" dy="18" x="255"><tspan id="SvgjsTspan1209" style="text-decoration:;">一个线程因为head.waitstatus=0,而没有满足head.waitstatus=-1的判断 </tspan></tspan><tspan id="SvgjsTspan1210" dy="18" x="255"><tspan id="SvgjsTspan1211" style="text-decoration:;">，那么此时doReleasedShared方法不会进行unpark线程，这里做了一个</tspan></tspan><tspan id="SvgjsTspan1212" dy="18" x="255"><tspan id="SvgjsTspan1213" style="text-decoration:;">优化，当head.waitstaus=0的话会compareAndSetWaitStatus(h, 0, </tspan></tspan><tspan id="SvgjsTspan1214" dy="18" x="255"><tspan id="SvgjsTspan1215" style="text-decoration:;">Node.PROPAGATE)， 那么即使release方法没有唤醒后续节点。在后续节</tspan></tspan><tspan id="SvgjsTspan1216" dy="18" x="255"><tspan id="SvgjsTspan1217" style="text-decoration:;">点的acquire方法的setHeadProagate方法中仍然可以通过判断</tspan></tspan><tspan id="SvgjsTspan1218" dy="18" x="255"><tspan id="SvgjsTspan1219" style="text-decoration:;">h.waitstatus=0,来之前漏唤醒的线程唤醒**</tspan></tspan></text></g></g><g id="SvgjsG1220"><path id="SvgjsPath1221" d="M1244.62500166893 646.1250019073486L1244.6250016689298 744.924995803833" stroke="#323232" stroke-width="2" fill="none" marker-end="url(#SvgjsMarker1222)"></path><rect id="SvgjsRect1224" width="134" height="45" x="1177.62500166893" y="673.0249988555909" fill="#ffffff"></rect><text id="SvgjsText1225" font-family="微软雅黑" text-anchor="middle" font-size="18px" width="134px" fill="#323232" font-weight="700" align="top" lineHeight="23px" anchor="middle" family="微软雅黑" size="18px" weight="700" font-style="" opacity="1" y="670.7749988555909" transform="rotate(0)"><tspan id="SvgjsTspan1226" dy="22" x="1244.62500166893"><tspan id="SvgjsTspan1227" style="text-decoration:;">前置节点是head</tspan></tspan><tspan id="SvgjsTspan1228" dy="22" x="1244.62500166893"><tspan id="SvgjsTspan1229" style="text-decoration:;">获取了锁</tspan></tspan></text></g><g id="SvgjsG1230" transform="translate(62.808339436848996,1125.9916661580405)"><path id="SvgjsPath1231" d="M 0 0L 311.6666704813639 0L 311.6666704813639 30.133347193400027L 0 30.133347193400027Z" stroke="rgba(50,50,50,1)" stroke-width="2" fill-opacity="1" fill="#ffffff"></path><g id="SvgjsG1232"><text id="SvgjsText1233" font-family="微软雅黑" text-anchor="middle" font-size="20px" width="292px" fill="#323232" font-weight="400" align="top" lineHeight="125%" anchor="middle" family="微软雅黑" size="20px" weight="400" font-style="" opacity="1" y="-2.5" transform="rotate(0)"><tspan id="SvgjsTspan1234" dy="25" x="156"><tspan id="SvgjsTspan1235" style="text-decoration:;">release(int args)</tspan></tspan></text></g></g><g id="SvgjsG1236" transform="translate(989.6916469732921,1235.6583328247073)"><path id="SvgjsPath1237" d="M 0 0L 556.9166921774545 0L 556.9166921774545 580.1334082285562L 0 580.1334082285562Z" stroke="rgba(50,50,50,1)" stroke-width="2" fill-opacity="1" fill="#ffffff"></path><g id="SvgjsG1238"><text id="SvgjsText1239" font-family="微软雅黑" text-anchor="middle" font-size="20px" width="537px" fill="#323232" font-weight="400" align="top" lineHeight="125%" anchor="middle" family="微软雅黑" size="20px" weight="400" font-style="" opacity="1" y="-2.5" transform="rotate(0)"><tspan id="SvgjsTspan1240" dy="25" x="278.5"><tspan id="SvgjsTspan1241" style="text-decoration:;">releaseShared(int args)</tspan></tspan></text></g></g><g id="SvgjsG1242" transform="translate(1092.5833341677983,1286.3916524251304)"><path id="SvgjsPath1243" d="M 0 0L 327.58336218198133 0L 327.58336218198133 24.73336092631007L 0 24.73336092631007Z" stroke="rgba(50,50,50,1)" stroke-width="2" fill-opacity="1" fill="#ffffff"></path><g id="SvgjsG1244"><text id="SvgjsText1245" font-family="微软雅黑" text-anchor="middle" font-size="15px" width="308px" fill="#323232" font-weight="400" align="top" lineHeight="125%" anchor="middle" family="微软雅黑" size="15px" weight="400" font-style="" opacity="1" y="-1.875" transform="rotate(0)"><tspan id="SvgjsTspan1246" dy="18" x="164"><tspan id="SvgjsTspan1247" style="text-decoration:;">tryReleaseShared(int releases)</tspan></tspan></text></g></g><g id="SvgjsG1248" transform="translate(1021.8750152587891,1373.3916524251304)"><path id="SvgjsPath1249" d="M 0 0L 469.0000000000002 0L 469.0000000000002 284.7334219614663L 0 284.7334219614663Z" stroke="rgba(50,50,50,1)" stroke-width="2" fill-opacity="1" fill="#ffffff"></path><g id="SvgjsG1250"><text id="SvgjsText1251" font-family="微软雅黑" text-anchor="middle" font-size="15px" width="450px" fill="#323232" font-weight="400" align="top" lineHeight="125%" anchor="middle" family="微软雅黑" size="15px" weight="400" font-style="" opacity="1" y="-1.875" transform="rotate(0)"><tspan id="SvgjsTspan1252" dy="18" x="235"><tspan id="SvgjsTspan1253" style="text-decoration:;">doReleaseShared()</tspan></tspan><tspan id="SvgjsTspan1254" dy="18" x="235"><tspan id="SvgjsTspan1255" style="text-decoration:;">循环获取head节点</tspan></tspan><tspan id="SvgjsTspan1256" dy="18" x="235"><tspan id="SvgjsTspan1257" style="text-decoration:;"> </tspan></tspan><tspan id="SvgjsTspan1258" dy="18" x="235"><tspan id="SvgjsTspan1259" style="text-decoration:;">如果队列当中包含一个入队节点的时候，如果head的状态</tspan></tspan><tspan id="SvgjsTspan1260" dy="18" x="235"><tspan id="SvgjsTspan1261" style="text-decoration:;">Node.SIGNAL -1为阻塞，说明，head的下一节点需要唤醒。调用</tspan></tspan><tspan id="SvgjsTspan1262" dy="18" x="235"><tspan id="SvgjsTspan1263" style="text-decoration:;">unparkSuccessor(h) LockSupport.unpark，head节点所在的线程</tspan></tspan><tspan id="SvgjsTspan1264" dy="18" x="235"><tspan id="SvgjsTspan1265" style="text-decoration:;"> </tspan></tspan><tspan id="SvgjsTspan1266" dy="18" x="235"><tspan id="SvgjsTspan1267" style="text-decoration:;">如果为0说明后置节点可能需要被唤醒（在</tspan></tspan><tspan id="SvgjsTspan1268" dy="18" x="235"><tspan id="SvgjsTspan1269" style="text-decoration:;">shouldParkAfterFailedAcquire中尚未来的及把前置节点的</tspan></tspan><tspan id="SvgjsTspan1270" dy="18" x="235"><tspan id="SvgjsTspan1271" style="text-decoration:;">waitstatus设置为-1），也可能根本不存在，所以设置为</tspan></tspan><tspan id="SvgjsTspan1272" dy="18" x="235"><tspan id="SvgjsTspan1273" style="text-decoration:;">Node.Proagate.以便 在被唤醒 </tspan></tspan><tspan id="SvgjsTspan1274" dy="18" x="235"><tspan id="SvgjsTspan1275" style="text-decoration:;"> </tspan></tspan><tspan id="SvgjsTspan1276" dy="18" x="235"><tspan id="SvgjsTspan1277" style="text-decoration:;"> </tspan></tspan></text></g></g><g id="SvgjsG1278"><path id="SvgjsPath1279" d="M1088.49165002505 1298.7583328882854L1059.49165002505 1298.7583328882854L1059.49165002505 1214.1250133514404L211.99167362848925 1214.1250133514404L211.99167362848925 1230.1250133514404" stroke="#f57f17" stroke-width="10" fill="none" marker-end="url(#SvgjsMarker1280)"></path></g><g id="SvgjsG1282"><path id="SvgjsPath1283" d="M377.87500953674316 1141.0583397547405L683.2833282550176 1141.0583397547405L683.2833282550176 1525.7250369389853L975.6916469732921 1525.7250369389853" stroke="#64b5f6" stroke-width="10" fill="none" marker-end="url(#SvgjsMarker1284)"></path></g><g id="SvgjsG1286" transform="translate(53.90833886464446,1244.1250133514404)"><path id="SvgjsPath1287" d="M 0 0L 316.1666695276895 0L 316.1666695276895 61L 0 61Z" stroke="rgba(50,50,50,1)" stroke-width="2" fill-opacity="1" fill="#ffffff"></path><g id="SvgjsG1288"><text id="SvgjsText1289" font-family="微软雅黑" text-anchor="middle" font-size="20px" width="297px" fill="#323232" font-weight="400" align="top" lineHeight="125%" anchor="middle" family="微软雅黑" size="20px" weight="400" font-style="" opacity="1" y="-2.5" transform="rotate(0)"><tspan id="SvgjsTspan1290" dy="25" x="158.5"><tspan id="SvgjsTspan1291" style="text-decoration:;">tryReleaseShared(int releases)</tspan></tspan><tspan id="SvgjsTspan1292" dy="25" x="158.5"><tspan id="SvgjsTspan1293" style="text-decoration:;">cas 改变AQS的state方法，</tspan></tspan></text></g></g><g id="SvgjsG1294"><path id="SvgjsPath1295" d="M1253.3329223606 1312.1237829487266L1256.1964867783759 1369.7960818749004" stroke="#323232" stroke-width="2" fill="none" marker-end="url(#SvgjsMarker1296)"></path><rect id="SvgjsRect1298" width="38" height="22" x="1235.764704569488" y="1329.9599324118135" fill="#ffffff"></rect><text id="SvgjsText1299" font-family="微软雅黑" text-anchor="middle" font-size="18px" width="38px" fill="#323232" font-weight="700" align="top" lineHeight="23px" anchor="middle" family="微软雅黑" size="18px" weight="700" font-style="" opacity="1" y="1327.7099324118135" transform="rotate(0)"><tspan id="SvgjsTspan1300" dy="22" x="1254.764704569488"><tspan id="SvgjsTspan1301" style="text-decoration:;">true</tspan></tspan></text></g><g id="SvgjsG1302"><path id="SvgjsPath1303" d="M1244.62500166893 1021.9916699727378L1244.62500166893 1050.9916699727378L1655.8750152587893 1050.9916699727378L1655.8750152587893 1515.7583634058635L1498.3750152587893 1515.7583634058635" stroke="#323232" stroke-width="5" fill="none" marker-end="url(#SvgjsMarker1304)"></path><rect id="SvgjsRect1306" width="447" height="48" x="1432.375015258789" y="1118.000009894371" fill="#ffffff"></rect><text id="SvgjsText1307" font-family="微软雅黑" text-anchor="middle" font-size="19px" width="447px" fill="#323232" font-weight="700" align="top" lineHeight="24px" anchor="middle" family="微软雅黑" size="19px" weight="700" font-style="" opacity="1" y="1115.625009894371" transform="rotate(0)"><tspan id="SvgjsTspan1308" dy="23" x="1655.875015258789"><tspan id="SvgjsTspan1309" style="text-decoration:;">propagate &gt; 0 || h == null || h.waitStatus &lt; 0 ||</tspan></tspan><tspan id="SvgjsTspan1310" dy="23" x="1655.875015258789"><tspan id="SvgjsTspan1311" style="text-decoration:;">            (h = head) == null || h.waitStatus &lt; 0</tspan></tspan></text></g></svg>